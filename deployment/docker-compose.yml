version: '3.8'

services:
  # ==========================================================
  # üß† Cyberbullying API Service
  # ==========================================================
  api:
    container_name: cyberbullying-api
    image: cyberbullying-api:latest   # ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ build: ‡∏ñ‡πâ‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "5002:5002"
    environment:
      # URI ‡∏Ç‡∏≠‡∏á‡πÇ‡∏°‡πÄ‡∏î‡∏•‡πÉ‡∏ô MLflow Registry
      - MODEL_URI=models:/cyberbullying-tweet-classifier@staging
      # MLflow Tracking Server (‡πÉ‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏†‡∏≤‡∏¢‡πÉ‡∏ô compose)
      - MLFLOW_TRACKING_URI=http://mlflow:5000
      # ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠ Flask app
      - FLASK_APP=api/app.py
    depends_on:
      - mlflow
    volumes:
      # Mount ‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå model ‡∏´‡∏£‡∏∑‡∏≠ artifact ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏ì‡∏µ‡πÉ‡∏ä‡πâ local path
      - ./models:/app/models
      - ./api:/app/api
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5002/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 40s

  # ==========================================================
  # üì¶ MLflow Tracking Server (Optional)
  # ==========================================================
  mlflow:
    image: ghcr.io/mlflow/mlflow:latest
    container_name: mlflow
    command: >
      mlflow server
      --backend-store-uri sqlite:///mlflow.db
      --default-artifact-root /mlruns
      --host 0.0.0.0
      --port 5000
    ports:
      - "5000:5000"
    volumes:
      - ./mlruns:/mlruns
      - ./mlflow.db:/mlflow.db
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000"]
      interval: 30s
      timeout: 5s
      retries: 3

  # ==========================================================
  # üóÑÔ∏è Optional: PostgreSQL ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö production MLflow backend
  # ==========================================================
  # db:
  #   image: postgres:15
  #   container_name: mlflow-db
  #   environment:
  #     POSTGRES_USER: mlflow
  #     POSTGRES_PASSWORD: mlflow123
  #     POSTGRES_DB: mlflow_db
  #   volumes:
  #     - ./postgres-data:/var/lib/postgresql/data
  #   ports:
  #     - "5432:5432"
  #   restart: unless-stopped
